function spherical_viewer(){function a(a,b,c){const d=a.createShader(b);if(a.shaderSource(d,c),a.compileShader(d),a.getShaderParameter(d,a.COMPILE_STATUS))return d;const e=a.getShaderInfoLog(d);throw a.deleteShader(d),"createShader:"+e}function b(a,b,c){const d=a.createProgram();if(a.attachShader(d,b),a.attachShader(d,c),a.linkProgram(d),a.getProgramParameter(d,a.LINK_STATUS))return d;const e=a.getProgramInfoLog(d);throw a.deleteProgram(d),"createProgram:"+e}function c(a,b,c){l.cam=l.cam.rotateX(a/l.r*e()).rotateY(-b/l.r*e()),l.z=Math.max(k.zMin,Math.min(l.z+.1*(c/l.r)*e(),k.zMax));const d=Date.now()-o;0<d&&(o+=d,l.vx=a/d,l.vy=b/d,l.vz=c/d),l.valid=!1}function d(a,b,c){l.cam=l.cam.rotateX(a/l.r*e()).rotateY(-b/l.r*e()),l.z=Math.max(k.zMin,Math.min(l.z+.1*(c/l.r)*e(),k.zMax)),l.valid=!1}function e(){return 1+k.pRate}function f(a){if(!l.dragging){const b=Math.sqrt(l.vx*l.vx+l.vy*l.vy+l.vz*l.vz);.01>b?(l.vx=0,l.vy=0,l.vz=0):(d(l.vx*a,l.vy*a,l.vz*a),l.vx*=k.att,l.vy*=k.att,l.vz*=k.att)}}function g(){l.r=1.5*l.width;const a=l.width,b=l.height,c=i();c[11]=k.pRate;const d=i().concat(l.cam).concat(c).scale(l.r).scale({x:-1/a,y:1/b,z:1/l.r}).translateZ(-.1);n.enable(n.DEPTH_TEST),n.clearColor(0,0,0,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);const e=n.getUniformLocation(p,"uMatrix");n.uniformMatrix4fv(e,!1,d);const f=n.getUniformLocation(p,"strength");n.uniform1f(f,1.3);const g=n.getUniformLocation(p,"zoom");n.uniform1f(g,l.z),n.drawArrays(n.TRIANGLE_STRIP,0,l.numPoints)}function h(a){0!=l.lastTime&&f(a-l.lastTime),l.lastTime=a,(l.width!=n.canvas.width||l.height!=n.canvas.height)&&(l.width=n.canvas.width,l.height=n.canvas.height,n.viewport(0,0,l.width,l.height),l.valid=!1),l.valid||(g(),l.valid=!0),window.requestAnimationFrame(h)}const i=function(){function a(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}const b={concat:function(a){const b=[];b.length=16;for(let c,d=0;d<b.length;d++){c=0;for(let b=0;4>b;b++)c+=this[4*~~(d/4)+b]*a[d%4+4*b];b[d]=c}return i(b)},transform:function(a){const b=[];b.length=a.length;for(let c,d=0;d<b.length;d++){c=0;for(let b=0;b<a.length;b++)c+=this[4*b+d]*a[b];b[d]=c}return b},translateX:function(a){return this.concat([1,0,0,0,0,1,0,0,0,0,1,0,a,0,0,1])},translateY:function(a){return this.concat([1,0,0,0,0,1,0,0,0,0,1,0,0,a,0,1])},translateZ:function(a){return this.concat([1,0,0,0,0,1,0,0,0,0,1,0,0,0,a,1])},scaleX:function(a){return this.concat([a,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},scaleY:function(a){return this.concat([1,0,0,0,0,a,0,0,0,0,1,0,0,0,0,1])},scaleZ:function(a){return this.concat([1,0,0,0,0,1,0,0,0,0,a,0,0,0,0,1])},rotateX:function(a){const b=Math.cos(a),c=Math.sin(a);return this.concat([1,0,0,0,0,b,c,0,0,-c,b,0,0,0,0,1])},rotateY:function(a){const b=Math.cos(a),c=Math.sin(a);return this.concat([b,0,-c,0,0,1,0,0,c,0,b,0,0,0,0,1])},rotateZ:function(a){const b=Math.cos(a),c=Math.sin(a);return this.concat([b,c,0,0,-c,b,0,0,0,0,1,0,0,0,0,1])},translate:function(a){return this.translateX(a.x||0).translateY(a.y||0).translateZ(a.z||0)},scale:function(a){return"number"==typeof a?this.scale({x:a,y:a,z:a}):this.scaleX(a.x||1).scaleY(a.y||1).scaleZ(a.z||1)},__proto__:[].__proto__};return function(c){return c=c||a(),c.__proto__=b,c}}(),j=64,k={src:"snap.jpg",width:1280,height:768,hDiv:j,vDiv:j<<1,zMin:1,zMax:5,att:.98,pRate:1,maxTextureSize:4096},l={valid:!1,lastTime:0,width:0,height:0,numPoints:0,r:0,z:1,dragging:!1,cam:i(),vx:0,vy:-.5,vz:0},m=document.createElement("canvas");m.setAttribute("width",""+k.width),m.setAttribute("height",""+k.height),m.style.cursor="all-scroll";const n=m.getContext("webgl")||m.getContext("experimental-webgl",{preserveDrawingBuffer:!0});if(!n)return console.log("gl not supported."),null;let o=Date.now();const p=function(){const c=a(n,n.VERTEX_SHADER,`attribute vec4 aPosition;uniform mat4 uMatrix;attribute vec2 aTexcoord;varying vec2 vTexcoord;uniform float strength;uniform float zoom;float correctionRadius = sqrt(8.0) / strength; void main() {vec4 nPosition = uMatrix * aPosition;float r = sqrt(nPosition.x * nPosition.x + nPosition.y * nPosition.y) / correctionRadius;float theta = r == 0.0 ? 1.0 : atan(r) / r;gl_Position = vec4(nPosition.x / theta * zoom, nPosition.y / theta * zoom, sign(nPosition.z), nPosition.w);vTexcoord = aTexcoord;}`),d=a(n,n.FRAGMENT_SHADER,`precision mediump float;varying vec2 vTexcoord;uniform sampler2D uTexture;void main() {gl_FragColor = texture2D(uTexture, vTexcoord);}`),e=b(n,c,d);return n.useProgram(e),e}();return function(){const a=n.createTexture();n.bindTexture(n.TEXTURE_2D,a),n.texImage2D(n.TEXTURE_2D,0,n.RGB,1,1,0,n.RGB,n.UNSIGNED_BYTE,new Uint8Array([63,63,63]));const b=new Image;b.addEventListener("load",function(){let c=n.getParameter(n.MAX_TEXTURE_SIZE);k.maxTextureSize&&(c=Math.min(c,k.maxTextureSize));const d=c,e=d>>1,f=document.createElement("canvas");f.setAttribute("width",""+d),f.setAttribute("height",""+e);const g=f.getContext("2d");g.drawImage(b,0,0,d,e),n.bindTexture(n.TEXTURE_2D,a),n.texImage2D(n.TEXTURE_2D,0,n.RGB,n.RGB,n.UNSIGNED_BYTE,f),n.generateMipmap(n.TEXTURE_2D),l.valid=!1});const c=document.getElementById("l"),d=new XMLHttpRequest;d.open("GET",k.src,!0),d.responseType="arraybuffer";let f=null;d.onloadstart=function(){f=setTimeout(function(){c.innerText=`Loading ...`},1e3)},d.onprogress=function(a){a.lengthComputable&&(clearTimeout(f),c.innerText=a.loaded===a.total?"":`Loading ... ${parseInt(100*(a.loaded/a.total))}%`)},d.onload=function(){clearTimeout(f),c.innerText="",b.src=window.URL.createObjectURL(new Blob([d.response],{type:d.getAllResponseHeaders().match(/^Content-Type\:\s*(.*?)$/mi)[1]||"image/jpeg"}))},d.send()}(),l.numPoints=function(){function a(a,c,f){const g=2*Math.PI*a/64,h=Math.PI*((c+f)/b-.5),i=Math.sin(h)*Math.PI/2;d.push(Math.cos(g)*Math.cos(i)),d.push(Math.sin(i)),d.push(Math.sin(g)*Math.cos(i)),e.push(c+a/64),e.push((1-Math.sin(h))/2)}const b=k.vDiv,c=k.hDiv,d=[],e=[];for(let d=0;d<=b;d++)for(let e=0;e<c;e++)a(e,d,0==d?0:e/c-1),a(e,d,d==b?1:e/c);n.bindBuffer(n.ARRAY_BUFFER,n.createBuffer()),n.bufferData(n.ARRAY_BUFFER,new Float32Array(e),n.STATIC_DRAW);const f=n.getAttribLocation(p,"aTexcoord");n.enableVertexAttribArray(f),n.vertexAttribPointer(f,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,n.createBuffer()),n.bufferData(n.ARRAY_BUFFER,new Float32Array(d),n.STATIC_DRAW);const g=n.getAttribLocation(p,"aPosition");return n.enableVertexAttribArray(g),n.vertexAttribPointer(g,3,n.FLOAT,!1,0,0),d.length/3}(),"undefined"==typeof window.ontouchstart?function(){let a=null;m.addEventListener("mousemove",function(b){l.dragging&&(b.preventDefault(),c(b.pageY-a.pageY,b.pageX-a.pageX,0),a={pageX:b.pageX,pageY:b.pageY})}),m.addEventListener("mouseup",function(a){a.preventDefault(),l.dragging=!1}),m.addEventListener("mousedown",function(b){b.preventDefault(),a={pageX:b.pageX,pageY:b.pageY},l.dragging=!0}),m.addEventListener("wheel",function(a){a.preventDefault(),c(0,0,a.deltaY)})}():function(){function a(a){const b=[];for(let c=0;c<a.touches.length;c++)b.push({pageX:a.touches[c].pageX,pageY:a.touches[c].pageY});return b}let b=null;m.addEventListener("touchmove",function(e){if(l.dragging){if(1==e.touches.length&&1==b.length)c(e.touches[0].pageY-b[0].pageY,e.touches[0].pageX-b[0].pageX,0);else if(2==e.touches.length&&2==b.length){function a(a){const b=a[0].pageX-a[1].pageX,c=a[0].pageY-a[1].pageY;return 10*Math.sqrt(b*b+c*c)}c(0,0,a(e.touches)-a(b))}b=a(e)}}),m.addEventListener("touchend",function(a){0==a.touches.length&&(b=null,l.dragging=!1)}),m.addEventListener("touchstart",function(c){c.preventDefault(),null==b&&(b=a(c),l.dragging=!0)})}(),window.requestAnimationFrame(h),m}
